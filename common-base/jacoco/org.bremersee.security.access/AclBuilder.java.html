<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AclBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">common-base</a> &gt; <a href="index.source.html" class="el_package">org.bremersee.security.access</a> &gt; <span class="el_source">AclBuilder.java</span></div><h1>AclBuilder.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2019 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.bremersee.security.access;

import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.Map;
import java.util.Objects;
import java.util.Optional;
import javax.validation.constraints.NotNull;
import org.bremersee.common.model.AccessControlList;
import org.bremersee.security.core.AuthorityConstants;
import org.springframework.lang.Nullable;
import org.springframework.util.StringUtils;
import org.springframework.validation.annotation.Validated;

/**
 * The access control list builder.
 *
 * @author Christian Bremer
 */
@Validated
public interface AclBuilder {

  /**
   * Instantiates a new access control list builder.
   *
   * @return the acl builder
   */
  static AclBuilder builder() {
<span class="fc" id="L47">    return new Impl();</span>
  }

  /**
   * Reset acl builder.
   *
   * @return the acl builder
   */
  AclBuilder reset();

  /**
   * Add default access control entries for the given permissions.
   *
   * @param permissions the permissions
   * @return the acl builder
   */
  AclBuilder defaults(@Nullable String... permissions);

  /**
   * From access control list DTO.
   *
   * @param acl the acl dto
   * @return the acl builder
   */
  AclBuilder from(@Nullable AccessControlList acl);

  /**
   * From acl (entity).
   *
   * @param acl the acl (entity)
   * @return the acl builder
   */
  default AclBuilder from(@Nullable Acl&lt;? extends Ace&gt; acl) {
<span class="fc" id="L80">    return Optional.ofNullable(acl)</span>
<span class="fc" id="L81">        .map(a -&gt; from(a.getOwner(), a.entryMap()))</span>
<span class="fc" id="L82">        .orElse(this);</span>
  }

  /**
   * From acl (entity) values.
   *
   * @param owner the owner
   * @param map the acl (entity) entry map
   * @return the acl builder
   */
  AclBuilder from(String owner, Map&lt;String, ? extends Ace&gt; map);

  /**
   * Sets owner.
   *
   * @param owner the owner
   * @return the acl builder
   */
  AclBuilder owner(@Nullable String owner);

  /**
   * Sets guest.
   *
   * @param isPublic is public
   * @param permissions the permissions
   * @return the acl builder
   */
  AclBuilder guest(@Nullable Boolean isPublic, @Nullable String... permissions);

  /**
   * Adds user.
   *
   * @param user the user
   * @param permissions the permissions
   * @return the acl builder
   */
  AclBuilder addUser(@Nullable String user, @Nullable String... permissions);

  /**
   * Adds role.
   *
   * @param role the role
   * @param permissions the permissions
   * @return the acl builder
   */
  AclBuilder addRole(@Nullable String role, @Nullable String... permissions);

  /**
   * Adds group.
   *
   * @param group the group
   * @param permissions the permissions
   * @return the acl builder
   */
  AclBuilder addGroup(@Nullable String group, @Nullable String... permissions);

  /**
   * Removes user.
   *
   * @param user the user
   * @param permissions the permissions
   * @return the acl builder
   */
  AclBuilder removeUser(@Nullable String user, @Nullable String... permissions);

  /**
   * Removes role.
   *
   * @param role the role
   * @param permissions the permissions
   * @return the acl builder
   */
  AclBuilder removeRole(@Nullable String role, @Nullable String... permissions);

  /**
   * Removes group.
   *
   * @param group the group
   * @param permissions the permissions
   * @return the acl builder
   */
  AclBuilder removeGroup(@Nullable String group, @Nullable String... permissions);

  /**
   * Ensures admin access.
   *
   * @return the acl builder
   */
  default AclBuilder ensureAdminAccess() {
<span class="fc" id="L171">    return ensureAdminAccess(AuthorityConstants.ADMIN_ROLE_NAME);</span>
  }

  /**
   * Adds admin access.
   *
   * @param adminRole the admin role
   * @param permissions the permissions
   * @return the acl builder
   */
  default AclBuilder ensureAdminAccess(
      @Nullable String adminRole,
      @Nullable String... permissions) {

<span class="fc" id="L185">    return ensureAdminAccess(</span>
<span class="pc bpc" id="L186" title="1 of 2 branches missed.">        StringUtils.hasText(adminRole) ? Collections.singleton(adminRole) : null, permissions);</span>
  }

  /**
   * Adds admin access.
   *
   * @param adminRoles the admin roles
   * @param permissions the permissions
   * @return the acl builder
   */
  AclBuilder ensureAdminAccess(
      @Nullable Collection&lt;String&gt; adminRoles,
      @Nullable String... permissions);

  /**
   * Removes admin access.
   *
   * @return the acl builder
   */
  default AclBuilder removeAdminAccess() {
<span class="fc" id="L206">    return removeAdminAccess(AuthorityConstants.ADMIN_ROLE_NAME);</span>
  }

  /**
   * Removes admin access.
   *
   * @param adminRole the admin role
   * @param permissions the permissions
   * @return the acl builder
   */
  default AclBuilder removeAdminAccess(
      @Nullable String adminRole,
      @Nullable String... permissions) {

<span class="fc" id="L220">    return removeAdminAccess(</span>
<span class="pc bpc" id="L221" title="1 of 2 branches missed.">        StringUtils.hasText(adminRole) ? Collections.singleton(adminRole) : null, permissions);</span>
  }

  /**
   * Removes admin access.
   *
   * @param adminRoles the admin roles
   * @param permissions the permissions
   * @return the acl builder
   */
  AclBuilder removeAdminAccess(
      @Nullable Collection&lt;String&gt; adminRoles,
      @Nullable String... permissions);

  /**
   * Build acl.
   *
   * @param &lt;T&gt; the type of the acl
   * @param factory the factory
   * @return the acl
   */
  &lt;T&gt; T build(@NotNull AclFactory&lt;T&gt; factory);

  /**
   * Build acl.
   *
   * @return the acl
   */
  default Acl&lt;? extends Ace&gt; buildAcl() {
<span class="fc" id="L250">    return build((o, e) -&gt; new AclImpl(o, new HashMap&lt;&gt;(e)));</span>
  }

  /**
   * Build access control list.
   *
   * @return the access control list
   */
  default AccessControlList buildAccessControlList() {
<span class="fc" id="L259">    return build(AclFactory.dtoFactory());</span>
  }

  /**
   * The default access control list builder implementation.
   */
<span class="fc" id="L265">  class Impl implements AclBuilder {</span>

    private String owner;

<span class="fc" id="L269">    private Map&lt;String, Ace&gt; entries = new HashMap&lt;&gt;();</span>

    @Override
    public AclBuilder reset() {
<span class="fc" id="L273">      this.owner = null;</span>
<span class="fc" id="L274">      this.entries = new HashMap&lt;&gt;();</span>
<span class="fc" id="L275">      return this;</span>
    }

    @Override
    public AclBuilder defaults(final String... permissions) {
<span class="fc bfc" id="L280" title="All 2 branches covered.">      if (permissions != null) {</span>
<span class="fc" id="L281">        Arrays.stream(permissions).forEach(permission -&gt; {</span>
<span class="fc bfc" id="L282" title="All 2 branches covered.">          if (!entries.containsKey(permission)) {</span>
<span class="fc" id="L283">            entries.put(permission.toLowerCase(), new AceImpl());</span>
          }
<span class="fc" id="L285">        });</span>
      }
<span class="fc" id="L287">      return this;</span>
    }

    @Override
    public AclBuilder from(final AccessControlList acl) {
<span class="fc bfc" id="L292" title="All 2 branches covered.">      if (acl != null) {</span>
<span class="fc" id="L293">        this.owner = acl.getOwner();</span>
<span class="pc bpc" id="L294" title="1 of 2 branches missed.">        if (acl.getEntries() != null) {</span>
<span class="fc" id="L295">          acl.getEntries()</span>
<span class="fc" id="L296">              .stream()</span>
<span class="fc" id="L297">              .filter(Objects::nonNull)</span>
<span class="fc" id="L298">              .filter(accessControlEntry -&gt; StringUtils.hasText(accessControlEntry.getPermission()))</span>
<span class="fc" id="L299">              .forEach(accessControlEntry -&gt; {</span>
<span class="fc" id="L300">                guest(accessControlEntry.getGuest(), accessControlEntry.getPermission());</span>
<span class="pc bpc" id="L301" title="1 of 2 branches missed.">                if (accessControlEntry.getGroups() != null) {</span>
<span class="fc" id="L302">                  accessControlEntry</span>
<span class="fc" id="L303">                      .getGroups()</span>
<span class="fc" id="L304">                      .forEach(group -&gt; addGroup(</span>
<span class="fc" id="L305">                          group, accessControlEntry.getPermission().toLowerCase()));</span>
                }
<span class="pc bpc" id="L307" title="1 of 2 branches missed.">                if (accessControlEntry.getRoles() != null) {</span>
<span class="fc" id="L308">                  accessControlEntry</span>
<span class="fc" id="L309">                      .getRoles()</span>
<span class="fc" id="L310">                      .forEach(role -&gt; addRole(</span>
<span class="fc" id="L311">                          role, accessControlEntry.getPermission().toLowerCase()));</span>
                }
<span class="pc bpc" id="L313" title="1 of 2 branches missed.">                if (accessControlEntry.getUsers() != null) {</span>
<span class="fc" id="L314">                  accessControlEntry</span>
<span class="fc" id="L315">                      .getUsers()</span>
<span class="fc" id="L316">                      .forEach(user -&gt; addUser(</span>
<span class="fc" id="L317">                          user, accessControlEntry.getPermission().toLowerCase()));</span>
                }
<span class="fc" id="L319">              });</span>
        }
      }
<span class="fc" id="L322">      return this;</span>
    }

    @Override
    public AclBuilder from(String owner, Map&lt;String, ? extends Ace&gt; map) {
<span class="fc" id="L327">      this.owner = owner;</span>
<span class="pc bpc" id="L328" title="1 of 2 branches missed.">      if (map != null) {</span>
<span class="fc" id="L329">        map.entrySet()</span>
<span class="fc" id="L330">            .stream()</span>
<span class="fc" id="L331">            .filter(Objects::nonNull)</span>
<span class="fc" id="L332">            .filter(entry -&gt; StringUtils.hasText(entry.getKey()))</span>
<span class="pc bpc" id="L333" title="1 of 2 branches missed.">            .filter(entry -&gt; entry.getValue() != null)</span>
<span class="fc" id="L334">            .forEach(entry -&gt; {</span>
<span class="fc" id="L335">              final String permission = entry.getKey().toLowerCase();</span>
<span class="fc" id="L336">              final Ace ace = entry.getValue();</span>
<span class="fc" id="L337">              guest(ace.isGuest(), permission);</span>
<span class="fc" id="L338">              ace.getGroups().forEach(group -&gt; addGroup(group, permission));</span>
<span class="fc" id="L339">              ace.getRoles().forEach(role -&gt; addRole(role, permission));</span>
<span class="fc" id="L340">              ace.getUsers().forEach(user -&gt; addUser(user, permission));</span>
<span class="fc" id="L341">            });</span>
      }
<span class="fc" id="L343">      return this;</span>
    }

    @Override
    public AclBuilder owner(final String owner) {
<span class="fc" id="L348">      this.owner = owner;</span>
<span class="fc" id="L349">      return this;</span>
    }

    @Override
    public AclBuilder guest(final Boolean isPublic, final String... permissions) {
<span class="pc bpc" id="L354" title="1 of 2 branches missed.">      if (permissions != null) {</span>
<span class="fc" id="L355">        final boolean guest = Boolean.TRUE.equals(isPublic);</span>
<span class="fc bfc" id="L356" title="All 2 branches covered.">        if (guest) {</span>
<span class="fc" id="L357">          Arrays.stream(permissions)</span>
<span class="fc" id="L358">              .filter(StringUtils::hasText)</span>
<span class="fc" id="L359">              .map(String::toLowerCase)</span>
<span class="fc" id="L360">              .forEach(permission -&gt; entries</span>
<span class="fc" id="L361">                  .computeIfAbsent(permission, p -&gt; new AceImpl())</span>
<span class="fc" id="L362">                  .setGuest(true));</span>
        } else {
<span class="fc" id="L364">          Arrays.stream(permissions)</span>
<span class="fc" id="L365">              .filter(StringUtils::hasText)</span>
<span class="fc" id="L366">              .map(String::toLowerCase)</span>
<span class="fc" id="L367">              .forEach(permission -&gt; entries.computeIfPresent(permission,</span>
                  (p, mongoAccessControlEntry) -&gt; {
<span class="fc" id="L369">                    mongoAccessControlEntry.setGuest(false);</span>
<span class="fc" id="L370">                    return mongoAccessControlEntry;</span>
                  }));
        }
      }
<span class="fc" id="L374">      return this;</span>
    }

    @Override
    public AclBuilder addUser(final String user, final String... permissions) {
<span class="pc bpc" id="L379" title="2 of 4 branches missed.">      if (StringUtils.hasText(user) &amp;&amp; permissions != null) {</span>
<span class="fc" id="L380">        Arrays.stream(permissions)</span>
<span class="fc" id="L381">            .filter(StringUtils::hasText)</span>
<span class="fc" id="L382">            .map(String::toLowerCase)</span>
<span class="fc" id="L383">            .forEach(permission -&gt; entries</span>
<span class="fc" id="L384">                .computeIfAbsent(permission, p -&gt; new AceImpl())</span>
<span class="fc" id="L385">                .getUsers()</span>
<span class="fc" id="L386">                .add(user));</span>
      }
<span class="fc" id="L388">      return this;</span>
    }

    @Override
    public AclBuilder addRole(final String role, final String... permissions) {
<span class="pc bpc" id="L393" title="2 of 4 branches missed.">      if (StringUtils.hasText(role) &amp;&amp; permissions != null) {</span>
<span class="fc" id="L394">        Arrays.stream(permissions)</span>
<span class="fc" id="L395">            .filter(StringUtils::hasText)</span>
<span class="fc" id="L396">            .map(String::toLowerCase)</span>
<span class="fc" id="L397">            .forEach(permission -&gt; entries</span>
<span class="fc" id="L398">                .computeIfAbsent(permission, p -&gt; new AceImpl())</span>
<span class="fc" id="L399">                .getRoles()</span>
<span class="fc" id="L400">                .add(role));</span>
      }
<span class="fc" id="L402">      return this;</span>
    }

    @Override
    public AclBuilder addGroup(final String group, final String... permissions) {
<span class="pc bpc" id="L407" title="2 of 4 branches missed.">      if (StringUtils.hasText(group) &amp;&amp; permissions != null) {</span>
<span class="fc" id="L408">        Arrays.stream(permissions)</span>
<span class="fc" id="L409">            .filter(StringUtils::hasText)</span>
<span class="fc" id="L410">            .map(String::toLowerCase)</span>
<span class="fc" id="L411">            .forEach(permission -&gt; entries</span>
<span class="fc" id="L412">                .computeIfAbsent(permission, p -&gt; new AceImpl())</span>
<span class="fc" id="L413">                .getGroups()</span>
<span class="fc" id="L414">                .add(group));</span>
      }
<span class="fc" id="L416">      return this;</span>
    }

    @Override
    public AclBuilder removeUser(final String user, final String... permissions) {
<span class="pc bpc" id="L421" title="2 of 4 branches missed.">      if (StringUtils.hasText(user) &amp;&amp; permissions != null) {</span>
<span class="fc" id="L422">        Arrays.stream(permissions)</span>
<span class="fc" id="L423">            .filter(StringUtils::hasText)</span>
<span class="fc" id="L424">            .map(String::toLowerCase)</span>
<span class="fc" id="L425">            .forEach(permission -&gt; entries.computeIfPresent(permission,</span>
                (p, mongoAccessControlEntry) -&gt; {
<span class="fc" id="L427">                  mongoAccessControlEntry.getUsers().remove(user);</span>
<span class="fc" id="L428">                  return mongoAccessControlEntry;</span>
                }));
      }
<span class="fc" id="L431">      return this;</span>
    }

    @Override
    public AclBuilder removeRole(final String role, final String... permissions) {
<span class="pc bpc" id="L436" title="2 of 4 branches missed.">      if (StringUtils.hasText(role) &amp;&amp; permissions != null) {</span>
<span class="fc" id="L437">        Arrays.stream(permissions)</span>
<span class="fc" id="L438">            .filter(StringUtils::hasText)</span>
<span class="fc" id="L439">            .map(String::toLowerCase)</span>
<span class="fc" id="L440">            .forEach(permission -&gt; entries.computeIfPresent(permission,</span>
                (p, mongoAccessControlEntry) -&gt; {
<span class="fc" id="L442">                  mongoAccessControlEntry.getRoles().remove(role);</span>
<span class="fc" id="L443">                  return mongoAccessControlEntry;</span>
                }));
      }
<span class="fc" id="L446">      return this;</span>
    }

    @Override
    public AclBuilder removeGroup(final String group, final String... permissions) {
<span class="pc bpc" id="L451" title="2 of 4 branches missed.">      if (StringUtils.hasText(group) &amp;&amp; permissions != null) {</span>
<span class="fc" id="L452">        Arrays.stream(permissions)</span>
<span class="fc" id="L453">            .filter(StringUtils::hasText)</span>
<span class="fc" id="L454">            .map(String::toLowerCase)</span>
<span class="fc" id="L455">            .forEach(permission -&gt; entries.computeIfPresent(permission,</span>
                (p, mongoAccessControlEntry) -&gt; {
<span class="fc" id="L457">                  mongoAccessControlEntry.getGroups().remove(group);</span>
<span class="fc" id="L458">                  return mongoAccessControlEntry;</span>
                }));
      }
<span class="fc" id="L461">      return this;</span>
    }

    @Override
    public AclBuilder ensureAdminAccess(
        final Collection&lt;String&gt; adminRoles,
        final String... permissions) {

<span class="pc bpc" id="L469" title="2 of 4 branches missed.">      if (adminRoles != null &amp;&amp; !adminRoles.isEmpty()) {</span>
<span class="pc bpc" id="L470" title="1 of 4 branches missed.">        if (permissions == null || permissions.length == 0) {</span>
<span class="fc" id="L471">          adminRoles.forEach(adminRole -&gt; entries.keySet()</span>
<span class="fc" id="L472">              .forEach(permission -&gt; addRole(adminRole, permission)));</span>
        } else {
<span class="fc" id="L474">          adminRoles.forEach(adminRole -&gt; addRole(adminRole, permissions));</span>
        }
      }
<span class="fc" id="L477">      return this;</span>
    }

    @Override
    public AclBuilder removeAdminAccess(
        final Collection&lt;String&gt; adminRoles,
        final String... permissions) {

<span class="pc bpc" id="L485" title="2 of 4 branches missed.">      if (adminRoles != null &amp;&amp; !adminRoles.isEmpty()) {</span>
<span class="pc bpc" id="L486" title="1 of 4 branches missed.">        if (permissions == null || permissions.length == 0) {</span>
<span class="fc" id="L487">          adminRoles.forEach(adminRole -&gt; entries.keySet()</span>
<span class="fc" id="L488">              .forEach(permission -&gt; removeRole(adminRole, permission)));</span>
        } else {
<span class="fc" id="L490">          adminRoles.forEach(adminRole -&gt; removeRole(adminRole, permissions));</span>
        }
      }
<span class="fc" id="L493">      return this;</span>
    }

    @Override
    public &lt;T&gt; T build(AclFactory&lt;T&gt; factory) {
<span class="fc" id="L498">      return factory.createAccessControlList(owner, entries);</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>